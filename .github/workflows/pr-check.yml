name: âœ… PR Build Check

on:
  pull_request:
    branches:
      - main
    paths:
      - 'client/**'
      - '.github/workflows/**'

jobs:
  build-check:
    name: ðŸ” Build & Test
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: production
      CI: false

    steps:
      - name: ðŸšš Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: client/package-lock.json

      - name: ðŸ“¦ Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            client/node_modules
            ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('client/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: ðŸ“ Create .env file
        working-directory: ./client
        run: |
          echo "REACT_APP_API_URL=https://api-staging.example.com" > .env
          echo "GENERATE_SOURCEMAP=false" >> .env

      - name: ðŸ”§ Install dependencies
        working-directory: ./client
        run: npm ci --prefer-offline --no-audit

      - name: ðŸ§ª Run tests (if available)
        working-directory: ./client
        run: |
          if grep -q '"test"' package.json; then
            npm test -- --passWithNoTests --watchAll=false
          else
            echo "âš ï¸ No tests configured, skipping..."
          fi

      - name: ðŸ”¨ Build React App
        working-directory: ./client
        run: |
          echo "ðŸ—ï¸ Building production bundle..."
          npm run build
          echo "âœ… Build completed successfully!"

      - name: ðŸ“Š Build size report
        working-directory: ./client
        run: |
          echo "## ðŸ“¦ Build Size Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Total Size" >> $GITHUB_STEP_SUMMARY
          du -sh build/ >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### JavaScript Files" >> $GITHUB_STEP_SUMMARY
          find build/static/js -name "*.js" -exec ls -lh {} \; | awk '{print "- " $9 ": " $5}' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### CSS Files" >> $GITHUB_STEP_SUMMARY
          find build/static/css -name "*.css" -exec ls -lh {} \; | awk '{print "- " $9 ": " $5}' >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“‚ Upload PR build
        uses: actions/upload-artifact@v3
        with:
          name: pr-build-${{ github.event.pull_request.number }}
          path: client/build/
          retention-days: 3
